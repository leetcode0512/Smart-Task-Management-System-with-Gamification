/**
 * @file main.cpp
 * @brief Smart Task Management System with Gamification - Main Entry Point
 * 
 * é¡¹ç›®: æ¸¸æˆåŒ–æ™ºèƒ½ä»»åŠ¡ç®¡ç†ç³»ç»Ÿ
 * æŠ€æœ¯æ ˆ: C++17, SQLite3, ANSIæ§åˆ¶å°UI
 * 
 * è´Ÿè´£äºº: Mao Jingqi (æˆå‘˜E)
 * å›¢é˜Ÿæˆå‘˜:
 *   - æˆå‘˜A (Fei Yifan): æé†’ç³»ç»Ÿã€æˆå°±ç³»ç»Ÿ
 *   - æˆå‘˜B (Zhou Tianjian): é¡¹ç›®ç®¡ç†ã€çƒ­åŠ›å›¾
 *   - æˆå‘˜C (Kuang Wenqing): ä»»åŠ¡ç®¡ç†
 *   - æˆå‘˜D (Yu Zhixuan): æ•°æ®åº“å±‚ã€DAO
 *   - æˆå‘˜E (Mao Jingqi): ç»Ÿè®¡åˆ†æã€UIã€XPç³»ç»Ÿã€ä¸»ç¨‹åº
 */

#include <iostream>
#include <string>
#include "database/DatabaseManager.h"
#include "ui/UIManager.h"
#include "statistics/StatisticsAnalyzer.h"
#include "gamification/XPSystem.h"

using namespace std;

/**
 * @brief æ˜¾ç¤ºæ¬¢è¿æ¨ªå¹…
 */
void displayWelcomeBanner() {
    cout << "\n";
    cout << "\033[1;36m"; // é’è‰²ç²—ä½“
    cout << R"(
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                           â•‘
â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—          â•‘
â•‘   â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•          â•‘
â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•   â–ˆâ–ˆâ•‘             â•‘
â•‘   â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘             â•‘
â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘             â•‘
â•‘   â•šâ•â•â•â•â•â•â•â•šâ•â•     â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•   â•šâ•â•             â•‘
â•‘                                                           â•‘
â•‘        Task Management System with Gamification          â•‘
â•‘                    Version 1.0                            â•‘
â•‘                                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
)" << "\033[0m"; // é‡ç½®é¢œè‰²
    cout << "\n";
}

/**
 * @brief åˆå§‹åŒ–ç³»ç»Ÿ
 * @return æ˜¯å¦åˆå§‹åŒ–æˆåŠŸ
 */
bool initializeSystem() {
    cout << "\033[1;33m"; // é»„è‰²ç²—ä½“
    cout << "ğŸš€ æ­£åœ¨å¯åŠ¨ç³»ç»Ÿ...\n" << "\033[0m";
    cout << "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
    
    // 1. åˆå§‹åŒ–æ•°æ®åº“
    cout << "ğŸ“¦ [1/3] åˆå§‹åŒ–æ•°æ®åº“..." << endl;
    DatabaseManager& db = DatabaseManager::getInstance();
    
    if (!db.initialize("task_manager.db")) {
        cerr << "\033[1;31mâŒ æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥ï¼\033[0m" << endl;
        cerr << "é”™è¯¯ä¿¡æ¯: " << db.getLastErrorMessage() << endl;
        return false;
    }
    
    cout << "\033[1;32mâœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ\033[0m" << endl;
    
    // 2. éªŒè¯æ•°æ®åº“è¡¨
    cout << "ğŸ” [2/3] éªŒè¯æ•°æ®åº“è¡¨..." << endl;
    
    bool allTablesExist = true;
    vector<string> requiredTables = {
        "tasks", "projects", "challenges", "reminders", 
        "achievements", "user_stats", "user_settings"
    };
    
    for (const string& table : requiredTables) {
        if (!db.tableExists(table)) {
            cerr << "\033[1;31mâŒ è¡¨ '" << table << "' ä¸å­˜åœ¨\033[0m" << endl;
            allTablesExist = false;
        } else {
            cout << "\033[1;32m  âœ“\033[0m è¡¨ '" << table << "' å°±ç»ª" << endl;
        }
    }
    
    if (!allTablesExist) {
        cerr << "\033[1;31mâŒ éƒ¨åˆ†æ•°æ®åº“è¡¨ç¼ºå¤±ï¼\033[0m" << endl;
        return false;
    }
    
    cout << "\033[1;32mâœ… æ‰€æœ‰æ•°æ®åº“è¡¨éªŒè¯é€šè¿‡\033[0m" << endl;
    
    // 3. æ£€æŸ¥æ•°æ®åº“å®Œæ•´æ€§
    cout << "ğŸ”’ [3/3] æ£€æŸ¥æ•°æ®åº“å®Œæ•´æ€§..." << endl;
    
    if (!db.checkDatabaseIntegrity()) {
        cerr << "\033[1;31mâŒ æ•°æ®åº“å®Œæ•´æ€§æ£€æŸ¥å¤±è´¥ï¼\033[0m" << endl;
        return false;
    }
    
    cout << "\033[1;32mâœ… æ•°æ®åº“å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡\033[0m" << endl;
    
    cout << "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
    cout << "\033[1;32mğŸ‰ ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼\033[0m\n\n";
    
    return true;
}

/**
 * @brief æ¸…ç†ç³»ç»Ÿèµ„æº
 */
void cleanupSystem() {
    cout << "\n\033[1;33mğŸ§¹ æ­£åœ¨æ¸…ç†ç³»ç»Ÿèµ„æº...\033[0m\n";
    
    // å…³é—­æ•°æ®åº“è¿æ¥
    DatabaseManager::destroyInstance();
    
    cout << "\033[1;32mâœ… èµ„æºæ¸…ç†å®Œæˆ\033[0m\n";
}

/**
 * @brief æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
 */
void displaySystemInfo() {
    cout << "\033[1;36m"; // é’è‰²
    cout << "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
    cout << "ğŸ“‹ ç³»ç»Ÿä¿¡æ¯:\n";
    cout << "  â€¢ é¡¹ç›®åç§°: Smart Task Management System\n";
    cout << "  â€¢ ç‰ˆæœ¬: 1.0.0\n";
    cout << "  â€¢ æŠ€æœ¯æ ˆ: C++17, SQLite3\n";
    cout << "  â€¢ å¼€å‘å›¢é˜Ÿ: CSC3002 Group Project Team\n";
    cout << "  â€¢ å¼€å‘å‘¨æœŸ: 2025-11-08 ~ 2025-11-30\n";
    cout << "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
    cout << "\033[0m"; // é‡ç½®é¢œè‰²
    cout << "\n";
}

/**
 * @brief ä¸»å‡½æ•°
 */
int main(int argc, char* argv[]) {
    try {
        // æ˜¾ç¤ºæ¬¢è¿æ¨ªå¹…
        displayWelcomeBanner();
        
        // æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
        displaySystemInfo();
        
        // åˆå§‹åŒ–ç³»ç»Ÿ
        if (!initializeSystem()) {
            cerr << "\033[1;31mğŸ’¥ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œç¨‹åºé€€å‡º\033[0m\n";
            return 1;
        }
        
        // åˆ›å»ºå¹¶è¿è¡ŒUIç®¡ç†å™¨
        cout << "\033[1;36mğŸ® å¯åŠ¨ç”¨æˆ·ç•Œé¢...\033[0m\n\n";
        
        UIManager* ui = new UIManager();
        ui->run();
        
        // æ¸…ç†UIèµ„æº
        delete ui;
        
        // æ¸…ç†ç³»ç»Ÿèµ„æº
        cleanupSystem();
        
        // æ˜¾ç¤ºé€€å‡ºä¿¡æ¯
        cout << "\n";
        cout << "\033[1;36m"; // é’è‰²
        cout << "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n";
        cout << "â•‘                                                   â•‘\n";
        cout << "â•‘          ğŸ‘‹ æ„Ÿè°¢ä½¿ç”¨ï¼æœŸå¾…ä¸‹æ¬¡å†è§ï¼              â•‘\n";
        cout << "â•‘                                                   â•‘\n";
        cout << "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n";
        cout << "\033[0m"; // é‡ç½®é¢œè‰²
        cout << "\n";
        
        return 0;
        
    } catch (const exception& e) {
        cerr << "\033[1;31m";
        cerr << "\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n";
        cerr << "â•‘                    ğŸ’¥ ç³»ç»Ÿé”™è¯¯                    â•‘\n";
        cerr << "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n";
        cerr << "\né”™è¯¯ä¿¡æ¯: " << e.what() << "\n";
        cerr << "\033[0m";
        
        // å°è¯•æ¸…ç†
        cleanupSystem();
        
        return 1;
    } catch (...) {
        cerr << "\033[1;31m";
        cerr << "\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n";
        cerr << "â•‘                  ğŸ’¥ æœªçŸ¥é”™è¯¯                      â•‘\n";
        cerr << "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n";
        cerr << "\033[0m";
        
        // å°è¯•æ¸…ç†
        cleanupSystem();
        
        return 1;
    }
}
